@page
@model KamWeb.Pages.ChatModel
@{
    ViewData["Title"] = "Voice Assistant";
}

<div class="vapi-container">
    <h2>Voice Assistant</h2>
    <p class="subtitle">Ask me a question by clicking the microphone or typing below</p>

    <div class="assistant-section">
        <div class="input-mode-tabs">
            <button id="voiceTab" class="mode-tab active" onclick="switchMode('voice')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
                Voice
            </button>
            <button id="textTab" class="mode-tab" onclick="switchMode('text')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z" />
                </svg>
                Text
            </button>
        </div>

        <div id="voiceMode" class="input-mode">
            <div class="microphone-area">
                <svg id="micIcon" class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
                <button id="startBtn" class="start-button">Start Conversation</button>
            </div>
        </div>

        <div id="textMode" class="input-mode" style="display: none;">
            <div class="text-input-area">
                <textarea id="textInput" class="text-input" placeholder="Type your question here..." rows="3"></textarea>
                <button id="sendBtn" class="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                    Send
                </button>
            </div>
        </div>

        <p id="status" class="status-text">Click to start</p>

        <div class="conversation-area">
            <div class="question-section">
                <h3>Your Question:</h3>
                <div id="questionText" class="text-display question-display">
                    <em>Waiting for your question...</em>
                </div>
            </div>

            <div class="answer-section">
                <div class="speaker-header">
                    <h3>My Answer:</h3>
                    <svg id="speakerIcon" class="speaker-icon-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                    </svg>
                </div>
                <div id="answerText" class="text-display answer-display">
                    <em>Waiting for question...</em>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .vapi-container {
        max-width: 900px;
        margin: 50px auto;
        padding: 20px;
    }

    h2 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
    }

    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
    }

    .assistant-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .input-mode-tabs {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 30px;
    }

    .mode-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid transparent;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
    }

        .mode-tab:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .mode-tab.active {
            background-color: white;
            color: #667eea;
            border-color: white;
        }

    .input-mode {
        min-height: 140px;
    }

    .microphone-area {
        text-align: center;
        margin-bottom: 20px;
    }

    .mic-icon {
        width: 80px;
        height: 80px;
        color: white;
        margin-bottom: 20px;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

        .mic-icon.listening {
            animation: pulse-mic 1.5s infinite;
        }

    @@keyframes pulse-mic {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.15);
            opacity: 0.8;
        }
    }

    .start-button {
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        background-color: white;
        color: #667eea;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .start-button.listening {
            background-color: #dc3545;
            color: white;
        }

        .start-button.processing {
            background-color: #ffc107;
            color: #333;
        }

        .start-button.speaking {
            background-color: #28a745;
            color: white;
        }

    .text-input-area {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
    }

    .text-input {
        width: 100%;
        max-width: 600px;
        padding: 15px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        resize: vertical;
        font-family: inherit;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

        .text-input:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
        }

    .send-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        background-color: white;
        color: #667eea;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-button.processing {
            background-color: #ffc107;
            color: #333;
        }

        .send-button.speaking {
            background-color: #28a745;
            color: white;
        }

    .status-text {
        text-align: center;
        font-size: 16px;
        color: white;
        font-weight: 500;
        margin-bottom: 30px;
        min-height: 24px;
    }

    .conversation-area {
        display: grid;
        gap: 20px;
    }

    .question-section, .answer-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

        .question-section h3 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .answer-section .speaker-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .answer-section h3 {
            color: #28a745;
            margin: 0;
            font-size: 18px;
        }

    .speaker-icon-small {
        width: 24px;
        height: 24px;
        color: #28a745;
    }

        .speaker-icon-small.speaking {
            animation: pulse-speaker 1s infinite;
        }

    @@keyframes pulse-speaker {
        0%, 100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }
    }

    .text-display {
        padding: 15px;
        border-radius: 8px;
        font-size: 16px;
        line-height: 1.6;
        min-height: 60px;
    }

    .question-display {
        background-color: #f0f4ff;
        color: #333;
    }

    .answer-display {
        background-color: #f0fff4;
        color: #333;
    }

    .text-display em {
        color: #999;
    }

    @@media (max-width: 768px) {
        .assistant-section {
            padding: 20px;
        }

        .mic-icon {
            width: 60px;
            height: 60px;
        }

        .start-button, .send-button {
            padding: 12px 30px;
            font-size: 16px;
        }

        .input-mode-tabs {
            flex-direction: column;
            gap: 10px;
        }

        .mode-tab {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<script>
    let recognition;
    let synth = window.speechSynthesis;
    let isListening = false;
    let isProcessing = false;
    let isSpeaking = false;
    let currentMode = 'voice';

    const startBtn = document.getElementById('startBtn');
    const sendBtn = document.getElementById('sendBtn');
    const textInput = document.getElementById('textInput');
    const status = document.getElementById('status');
    const questionText = document.getElementById('questionText');
    const answerText = document.getElementById('answerText');
    const micIcon = document.getElementById('micIcon');
    const speakerIcon = document.getElementById('speakerIcon');

    // Mode switching
    function switchMode(mode) {
        currentMode = mode;
        const voiceMode = document.getElementById('voiceMode');
        const textMode = document.getElementById('textMode');
        const voiceTab = document.getElementById('voiceTab');
        const textTab = document.getElementById('textTab');

        if (mode === 'voice') {
            voiceMode.style.display = 'block';
            textMode.style.display = 'none';
            voiceTab.classList.add('active');
            textTab.classList.remove('active');
            status.textContent = 'Click to start';
        } else {
            voiceMode.style.display = 'none';
            textMode.style.display = 'block';
            voiceTab.classList.remove('active');
            textTab.classList.add('active');
            status.textContent = 'Type your question and click Send';
        }

        // Reset state when switching modes
        if (isListening) {
            stopListening();
        }
        if (isSpeaking) {
            stopSpeaking();
        }
    }

    // Get anti-forgery token
    function getAntiForgeryToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }

    // Text mode: Send button handler
    sendBtn.addEventListener('click', () => {
        const question = textInput.value.trim();
        if (question && !isProcessing && !isSpeaking) {
            questionText.textContent = question;
            processQuestion(question);
            textInput.value = '';
        }
    });

    // Text mode: Enter key handler
    textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });

    // Check if browser supports speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        startBtn.addEventListener('click', () => {
            if (!isListening && !isProcessing && !isSpeaking) {
                startListening();
            } else if (isListening) {
                stopListening();
            } else if (isSpeaking) {
                stopSpeaking();
            }
        });

        function startListening() {
            recognition.start();
            isListening = true;
            startBtn.textContent = 'Stop Listening';
            startBtn.classList.add('listening');
            micIcon.classList.add('listening');
            status.textContent = 'Listening... Speak now';
            questionText.innerHTML = '<em>Listening...</em>';
        }

        function stopListening() {
            recognition.stop();
            isListening = false;
            startBtn.textContent = 'Start Conversation';
            startBtn.classList.remove('listening');
            micIcon.classList.remove('listening');
        }

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcriptPiece = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcriptPiece;
                } else {
                    interimTranscript += transcriptPiece;
                }
            }

            if (interimTranscript) {
                questionText.textContent = interimTranscript;
            }

            if (finalTranscript) {
                questionText.textContent = finalTranscript;
                processQuestion(finalTranscript);
            }
        };

        recognition.onerror = (event) => {
            status.textContent = 'Error: ' + event.error;
            resetState();
        };

        recognition.onend = () => {
            if (isListening && !isProcessing) {
                status.textContent = 'No speech detected. Click to try again.';
                resetState();
            }
        };
    } else {
        status.textContent = 'Speech recognition not supported. Please use text mode or try Chrome, Edge, or Safari.';
        startBtn.disabled = true;
        // Switch to text mode automatically
        switchMode('text');
    }

    async function processQuestion(question) {
        isListening = false;
        isProcessing = true;

        // Update UI based on current mode
        if (currentMode === 'voice') {
            startBtn.textContent = 'Processing...';
            startBtn.classList.remove('listening');
            startBtn.classList.add('processing');
            micIcon.classList.remove('listening');
        } else {
            sendBtn.textContent = 'Processing...';
            sendBtn.classList.add('processing');
            sendBtn.disabled = true;
        }

        status.textContent = 'Processing your question...';
        answerText.innerHTML = '<em>Thinking...</em>';

        try {
            const token = getAntiForgeryToken();
            const response = await fetch('/Chat?handler=GetAnswer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ question: question })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server error:', errorText);
                throw new Error(`Server responded with status ${response.status}`);
            }

            const data = await response.json();

            // Display answer text
            answerText.textContent = data.answer;

            // Immediately start speaking - no delay
            speakAnswerImmediately(data.answer);

        } catch (error) {
            console.error('Error:', error);
            status.textContent = 'Error: ' + error.message;
            answerText.textContent = 'Sorry, I encountered an error processing your question.';
            resetState();
        }
    }

    function speakAnswerImmediately(text) {
        // Update UI state immediately
        isProcessing = false;
        isSpeaking = true;
        status.textContent = 'Speaking answer...';

        if (currentMode === 'voice') {
            startBtn.textContent = 'Stop Speaking';
            startBtn.classList.remove('processing');
            startBtn.classList.add('speaking');
        } else {
            sendBtn.textContent = 'Stop Speaking';
            sendBtn.classList.remove('processing');
            sendBtn.classList.add('speaking');
            sendBtn.disabled = false;
        }

        speakerIcon.classList.add('speaking');

        // Cancel any ongoing speech first
        synth.cancel();

        // Create and speak utterance immediately
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        utterance.onend = () => {
            status.textContent = currentMode === 'voice' ? 'Done! Click to ask another question.' : 'Done! Type another question.';
            resetState();
        };

        utterance.onerror = (event) => {
            status.textContent = 'Error speaking: ' + event.error;
            resetState();
        };

        // Speak immediately
        synth.speak(utterance);
    }

    function stopSpeaking() {
        synth.cancel();
        status.textContent = currentMode === 'voice' ? 'Stopped. Click to ask another question.' : 'Stopped. Type another question.';
        resetState();
    }

    function resetState() {
        isListening = false;
        isProcessing = false;
        isSpeaking = false;

        if (currentMode === 'voice') {
            startBtn.textContent = 'Start Conversation';
            startBtn.classList.remove('listening', 'processing', 'speaking');
            micIcon.classList.remove('listening');
        } else {
            sendBtn.textContent = 'Send';
            sendBtn.classList.remove('processing', 'speaking');
            sendBtn.disabled = false;
        }

        speakerIcon.classList.remove('speaking');
    }

    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        status.textContent = 'Speech synthesis not supported in this browser.';
        if (currentMode === 'voice') {
            startBtn.disabled = true;
        }
    }
</script>

@* Anti-forgery token for AJAX calls *@
@Html.AntiForgeryToken()